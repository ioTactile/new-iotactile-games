---
description: Architecture du projet (DDD, Clean), stack technique et conventions
alwaysApply: true
---

# Architecture et projet — IoTactile Games

## Vue d'ensemble

- **Backend** : API dans `api/`, Fastify 5, full TypeScript, ESM (NodeNext). Auth implémentée : JWT (access + refresh), cookies https-only, bcrypt, Zod pour la validation des entrées.
- **Frontend** : Application dans `app/`, Next.js 16, React 19, Tailwind 4, full TypeScript.
- **Architecture** : Clean Architecture + DDD (Domain-Driven Design).
- **Base de données** : PostgreSQL avec Prisma 7 (client généré dans `api/generated/prisma`).
- **Jeu de dés** : domaine métier temps réel (sessions, joueurs, états de parties) exposé via des routes dédiées et un système de diffusion temps réel.

L'équipe installe elle-même les packages ; ne pas exécuter `npm install` / `pnpm add` sauf demande explicite.

### Documentation de référence

- **Fastify** : https://fastify.dev/docs/latest/Guides/
- **Prisma avec Fastify** : https://www.prisma.io/fastify
- **Biome** : https://biomejs.dev/ (format + lint utilisés dans l'API)
- **Next.js** : https://nextjs.org/docs

---

## Stack technique actuelle (API)

### Dépendances (api/package.json)

- **fastify** (^5.x) : serveur HTTP.
- **@fastify/cookie** : lecture/écriture des cookies (secret via `COOKIE_SECRET`).
- **@fastify/cors** (dev) : CORS avec origine(s) configurée(s), `credentials: true`.
- **@fastify/jwt** : émission et vérification des access/refresh tokens.
- **prisma** + **@prisma/client** (^7.x) : ORM, migrations, typage.
- **@prisma/adapter-pg** + **pg** : driver PostgreSQL pour Prisma.
- **dotenv** : variables d'environnement.
- **typescript-result** : type `Result<T, E>` pour les ports/use cases (erreurs explicites).
- **bcrypt** : hash et comparaison des mots de passe (adapters secondaires).
- **zod** : validation des entrées (body, query) et schémas partagés.
- **Redis (cache)** : client de cache pour les sessions de dés (configuré dans `api/src/pkg/cache/redis.ts`).

### Dev & outillage

- **TypeScript** (strict, `verbatimModuleSyntax`, `allowImportingTsExtensions`), **tsx** (dev/run).
- **Biome** : format + lint (indent tab, double quotes) ; scripts `format`, `lint`, `check`, `check:fix`.
- **Vitest** : tests unitaires et e2e ; coverage v8, UI disponible.
- **Pino** + **pino-pretty** : logging Fastify.
- **Husky** : hooks (pre-commit pour check + tests).

### Structure actuelle (api/src)

```
api/src/
  domain/                    # Entités, value objects, interfaces de repositories
    user/
      user.type.ts
      user.repository.ts
    dice/
      dice.type.ts
      dice.repository.ts
  application/
    command/                 # Use cases en écriture (auth utilisateur + jeu de dés)
      ports/                 # Interfaces (AuthTokenPort, PasswordHasherPort, DiceBroadcasterPort)
      usecases/user/
      usecases/dice/
    query/                   # Use cases en lecture (ex. get-user-by-id, list-public-dice-sessions)
      usecases/user/
      usecases/dice/
  adapters/
    primary/                 # Entrées : HTTP, CLI, etc.
      http/
        routes/              # Routes Fastify (auth.routes, user.routes, dice.routes, index)
        plugins/             # auth.plugin (requireAuth, requireAdmin, authToken)
        schemas/             # Schémas Zod (auth.schemas, dice.schemas)
    secondary/               # Sorties : persistance, sécurité, etc.
      persistence/           # PrismaUserRepository, PrismaDiceSessionRepository, CachedDiceSessionRepository, ...
      security/              # JwtAuthTokenAdapter, BcryptPasswordHasher
      realtime/              # DiceBroadcasterAdapter (impl. DiceBroadcasterPort)
  pkg/                       # Utilitaires partagés (hors domain/application)
    config/
    database/                # Prisma client (prisma.ts)
    logger/
    cache/                   # Cache Redis pour les sessions de dés
  types/                     # Déclarations (ex. fastify-auth.d.ts)
  server.ts                  # Bootstrap Fastify (CORS, cookie, jwt, authPlugin, routes, listen)
```

### Alias TypeScript (api/tsconfig.json)

- `@/*` → `src/*`
- `@/domain/*` → `src/domain/*`
- `@/application/*` → `src/application/*`
- `@/adapters/*` → `src/adapters/*`
- `@/ports/*` → `src/application/ports/*`

### Prisma

- **Schema** : `api/prisma/schema.prisma` ; générateur `prisma-client`, output `../generated/prisma`.
- **Config** : `api/prisma/prisma.config.ts` (et `api/prisma.config.ts` si présent).
- **Scripts** : `db:generate`, `db:push`, `db:migrate`, `db:migrate:deploy`, `db:studio`.

---

## Stack technique actuelle (Frontend — app/)

- **Next.js** 16 (App Router), **React** 19, **TypeScript**.
- **Tailwind CSS** 4 (PostCSS).
- **ESLint** (eslint-config-next).
- Structure : `app/src/app/` (pages, layout, globals.css), `app/public/`.

---

## DDD & Clean Architecture

### Principes

- **Domain** : cœurs métier (types, entités, interfaces de repositories) ; sans dépendance à Fastify, Prisma ou React.
- **Application** : use cases (command / query) et ports (interfaces) ; dépendent du domain uniquement ; utilisent `Result<T, E>` pour les sorties.
- **Adapters primary** : entrées (routes Fastify, plugins, schémas Zod) ; appellent les use cases, pas le domain directement.
- **Adapters secondary** : implémentations des ports (Prisma, JWT, bcrypt) ; pas de logique métier, uniquement mapping ↔ types du domain.

Les couches internes ne doivent pas importer les couches externes (dependency rule).

Exemples de bounded contexts actuels : `user` (authentification, comptes) et `dice` (sessions de dés, joueurs, états de partie, scores).

### Conventions

- **TypeScript strict** partout.
- **Zod** pour valider les entrées (body, query, cookies) côté API ; schémas dans `adapters/primary/http/schemas/`.
- **Pas de logique métier** dans les routes Fastify ; la logique vit dans le domain / application.
- **Prisma** : schémas et migrations versionnés ; pas de logique métier dans les adapters, uniquement mapping ↔ types du domain.
- **Auth** : plugin `authPlugin` décore le serveur avec `authToken` (AuthTokenPort) et les hooks `requireAuth` / `requireAdmin` ; les routes protégées utilisent ces hooks.

---

## Évolutions possibles (à venir)

### Backend

- **@fastify/helmet** : en-têtes de sécurité HTTP si besoin.
- Extension des use cases et routes selon les besoins métier.

### Frontend

- **TanStack Query** : cache, requêtes async, mutations vers l'API.
- **Cookies** : https-only ; refresh token en httpOnly si aligné avec l'API.
- **shadcn/ui**, **zustand**, **react-hook-form**, **zod** (schémas partagés avec l'API si besoin).

---

## Rappel packages (à installer par l'équipe)

- **API** (déjà présents) : `fastify`, `@fastify/cookie`, `@fastify/cors`, `@fastify/jwt`, `prisma`, `@prisma/client`, `@prisma/adapter-pg`, `pg`, `dotenv`, `typescript-result`, `bcrypt`, `zod` ; dev : `biome`, `vitest`, `tsx`, `pino`, `pino-pretty`, `husky`, `@types/bcrypt`.
- **App** (déjà présents) : `next`, `react`, `react-dom`, `tailwindcss`, `@tailwindcss/postcss`, `typescript`, `eslint`, `eslint-config-next`.

Ce fichier sert de référence pour l'architecture et les choix techniques ; les implémentations doivent rester alignées avec ces principes.
